<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- Update Project Folder Name -->
        <record id="automation_update_project_folder_name" model="base.automation">
            <field name="name">Update Project Folder Name</field>
            <field name="model_id" ref="project.model_project_project"/>
            <field name="trigger">on_create_or_write</field>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Update Project Folder Name - Automation Rule
# Renames the project's documents folder based on sales order and customer name
# Format: SO Name - Projet - Customer Name

try:
    # Only process if this is a new record (newly created project from template)
    if record and record.create_date == record.write_date:
        _logger.info("Processing new project (ID %s): %s", record.id, record.name)

        # Check if project has an associated sale order line
        if record.sale_line_id:
            # Get the sales order and client information
            sale_order = record.sale_line_id.order_id
            customer = sale_order.partner_id

            # Check if we have a documents folder created
            if record.documents_folder_id:
                # Create new folder name with SO reference and client name
                new_folder_name = f"{sale_order.name} - Projet - {customer.name}"

                if record.documents_folder_id.name != new_folder_name:
                    record.documents_folder_id.write({
                        'name': new_folder_name
                    })
                    _logger.info("Updated project folder name to: '%s' for project ID %s", new_folder_name, record.id)
                else:
                    _logger.info("Project folder name already correct for project ID %s", record.id)
            else:
                _logger.warning("No documents folder found for project ID %s", record.id)
        else:
            _logger.info("No sale order line linked to project ID %s, skipping folder rename", record.id)

except Exception as e:
    _logger.error("Update Project Folder Name - Error processing project ID %s: %s", record.id, str(e), exc_info=True)
]]></field>
        </record>

        <!-- Set Welcome Call Deadline -->
        <record id="automation_set_welcome_call_deadline" model="base.automation">
            <field name="name">Set Welcome Call Deadline</field>
            <field name="model_id" ref="project.model_project_task"/>
            <field name="trigger">on_create_or_write</field>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Set Welcome Call Deadline - Automation Rule
# Sets the deadline for "Welcom call" tasks to 2 days after the sales order date

try:
    # Only process if this is a new record (newly created task from template)
    if record and record.create_date == record.write_date:
        # Check if task name is "Welcom call" (using the exact spelling from the requirement)
        if record.name == "Welcom call":
            _logger.info("Processing Welcome call task (ID %s) for project %s", record.id, record.project_id.name if record.project_id else 'N/A')

            # Get the linked sales order from project_sale_order_id
            if record.project_sale_order_id:
                # Get the sales order date
                order_date = record.project_sale_order_id.date_order

                if order_date:
                    # Calculate deadline date (2 days after order date)
                    deadline_date = order_date + datetime.timedelta(days=2)

                    # Set the deadline to two days after the sales order date
                    record.write({
                        'date_deadline': deadline_date
                    })

                    # Log the action for tracking
                    _logger.info("Welcome call deadline set to %s (2 days after order date %s) for task ID %s in project %s", deadline_date, order_date, record.id, record.project_id.name)
                else:
                    _logger.warning("Sales order has no date_order for Welcome call task ID %s", record.id)
            else:
                _logger.warning("No project_sale_order_id linked to Welcome call task ID %s", record.id)

except Exception as e:
    _logger.error("Set Welcome Call Deadline - Error processing task ID %s: %s", record.id, str(e), exc_info=True)
]]></field>
        </record>

        <!-- Subscribe Admins to FSM Tasks -->
        <!-- Note: This rule had no code in the migration document, placeholder for future implementation -->
        <record id="automation_subscribe_admins_fsm_tasks" model="base.automation">
            <field name="name">Subscribe Admins to FSM Tasks</field>
            <field name="model_id" ref="project.model_project_task"/>
            <field name="trigger">on_create_or_write</field>
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Subscribe Admins to FSM Tasks - Automation Rule
# TODO: Implementation pending - no code was provided in the migration document

try:
    # Placeholder for future implementation
    # The original automation rule had no code in the migration document
    _logger.info("Subscribe Admins to FSM Tasks automation triggered for task ID %s - pending implementation", record.id)

except Exception as e:
    _logger.error("Subscribe Admins to FSM Tasks - Error processing task ID %s: %s", record.id, str(e), exc_info=True)
]]></field>
        </record>

    </data>
</odoo>
